---
title: "Maps"
author: "Grace Acton"
date: "`r Sys.Date()`"
output: html_document
---

## Libraries

```{r load-packages}

library(tidyverse) ## For plotting and data wrangling.

library(leaflet) ## For leaflet interactive maps

library(sf) ## For spatial data

library(RColorBrewer) ## For colour palettes

library(htmltools) ## For html

library(leafsync) ## For placing plots side by side

library(kableExtra) ## Table output

library(ggmap) ## for google geocoding

source("data_cleaning.R")
```

## Base Map

```{r load-data}
ma_towns <- st_read("data/townssurvey_shp/TOWNSSURVEY_POLYM.shp")
```

```{r join-shape}
map_data <- seamstresses %>% 
  filter(state == "MA") %>% 
  filter(is.na(city) == FALSE) %>% 
  select(city) %>% 
  mutate(city = case_when(city == "Williamsburgh" ~ "WILLIAMSBURG",
                          TRUE ~ toupper(city))) %>% 
  group_by(city) %>% 
  summarize(number = n()) %>% 
  right_join(y = ma_towns, by = c("city" = "TOWN")) %>% 
  select(city, number, geometry) 
```

```{r ggplot-map}
ggplot(data = map_data) +
  geom_sf(aes(geometry = geometry, fill = number)) +
  scale_fill_gradient(low = "lightskyblue", high = "midnightblue", na.value = "white") +
  labs(title = "Ads per Town",
       subtitle = "Massachusetts",
       color = "Number of Ads") +
  theme_void()
  
```
## Regionality of Job Titles

```{r job-titles-frequency}
job_title_popularity <- seamstresses %>% 
  separate_rows(job_title, sep = "; ") %>% 
  mutate(job_title = fct_collapse(job_title,
    Milliner = c("Milliner", "milliner"),
    Dressmaker = c("Dressmaker", "dressmaker"),
    Tailor = c("Tailor"),
    Tailoress = c("Tailoress", "tailoress"),
    Mantuamaker = c("Mantuamaker", "mantuamaker", "Mantua-Maker"),
    Apprentices = c("apprentices")
  )) %>% 
  filter(state == "MA", is.na(job_title) == FALSE, is.na(city) == FALSE) %>% 
  group_by(city) %>% 
  count(job_title) %>% 
  slice(which.max(n)) %>% 
  mutate(city = case_when(city == "Williamsburgh" ~ "WILLIAMSBURG",
                          TRUE ~ toupper(city))) %>% 
  right_join(y = ma_towns, by = c("city" = "TOWN")) %>% 
  select(city, job_title, geometry) 
```

```{r job-title-map}
ggplot(job_title_popularity) +
  geom_sf(aes(geometry = geometry, fill = job_title)) +
  scale_fill_manual(values = c("Apprentices" = "lightpink", "Dressmaker" = "lightskyblue", "Mantuamaker" = "lightgoldenrod", "Milliner" = "thistle", "Tailor" = "lightslategray", "Tailoress" = "darkseagreen1"), na.value = "white") +
  labs(title = "Most Popular Job Title",
         subtitle = "By Town",
         color = "Job Title") +
  theme_void()
```

```{r worcester-geo}

register_google(key = "AIzaSyBJKyY6SoLXHZlJ691STnK20wTleh4O6Aw")

worcester_geo <- worcester %>% 
  mutate_geocode(location = street_address, 
         output = "latlon", 
         source = "google") 

worcester_geo <- worcester_geo %>% 
  filter(name != "Lucina Grover",
         name != "Amelia Goodrich",
         name != "Harriet Fisk") %>% 
  mutate(lat = jitter(lat, factor = 0.005)) %>% 
  mutate(lon = jitter(lon, factor = 0.005)) %>% 
  mutate(popup = paste("<b>", name, "</b>" ,
                        "<br>", year, 
                        "<br>", job_title, 
                        "<br>", street_address,
                        "<br>", source_name)
         )

```

```{r worcester-map}



worcester_map <- leaflet(data = worcester_geo) %>% 
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>% 
  addCircleMarkers(
    radius = 6,
    fillColor = ~case_when(job_title == "Dressmaker" ~ "lightskyblue",
                       job_title == "Milliner" ~ "purple",
                       job_title == "Tailoress" ~ "yellow",
                       job_title == "Store Owner" ~ "lightgreen",
                       job_title == "Milliner; Dressmaker" ~ "pink"),
    color = "black",
    stroke = TRUE, 
    fillOpacity = 1,
    popup = ~popup) %>% 
  addLayersControl(
    baseGroups = c("OSM (default)", "Toner", "Toner Lite"),
    options = layersControlOptions(collapsed = FALSE)
  )

```

